name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰ç‰ˆæœ¬æ ‡ç­¾
      - 'v*.*'    # åŒ¹é… v1.0 ç­‰ç‰ˆæœ¬æ ‡ç­¾

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    - name: Configure CMake
      run: cmake -B build -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release --verbose

    - name: Verify Build Output
      shell: pwsh
      run: |
        Write-Host "=== æ£€æŸ¥æ„å»ºè¾“å‡º ==="
        if (Test-Path "build/Release/DS_AI_Quiz.exe") {
          Write-Host "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: build/Release/DS_AI_Quiz.exe"
          Get-Item "build/Release/DS_AI_Quiz.exe" | Format-List
        } elseif (Test-Path "build/DS_AI_Quiz.exe") {
          Write-Host "âœ… æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶: build/DS_AI_Quiz.exe"
          Get-Item "build/DS_AI_Quiz.exe" | Format-List
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ—å‡º build ç›®å½•å†…å®¹ï¼š"
          Get-ChildItem -Path "build" -Recurse -File -Filter "*.exe" | Format-Table
          exit 1
        }

    - name: Prepare Release Package
      shell: pwsh
      run: |
        Write-Host "=== å‡†å¤‡å‘è¡Œç‰ˆç›®å½• ==="

        # åˆ›å»ºå‘è¡Œç‰ˆç›®å½•ç»“æ„
        New-Item -ItemType Directory -Force -Path "release/DS_AI_Quiz" | Out-Null
        New-Item -ItemType Directory -Force -Path "release/DS_AI_Quiz/data" | Out-Null

        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå°è¯•ä¸¤ä¸ªå¯èƒ½çš„ä½ç½®ï¼‰
        if (Test-Path "build/Release/DS_AI_Quiz.exe") {
          Copy-Item "build/Release/DS_AI_Quiz.exe" -Destination "release/DS_AI_Quiz/"
          Write-Host "âœ… å¤åˆ¶: build/Release/DS_AI_Quiz.exe"
        } elseif (Test-Path "build/DS_AI_Quiz.exe") {
          Copy-Item "build/DS_AI_Quiz.exe" -Destination "release/DS_AI_Quiz/"
          Write-Host "âœ… å¤åˆ¶: build/DS_AI_Quiz.exe"
        } else {
          Write-Host "âŒ é”™è¯¯: æ‰¾ä¸åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          exit 1
        }

        # å¤åˆ¶æ•°æ®æ–‡ä»¶
        if (Test-Path "data/questions.csv") {
          Copy-Item "data/questions.csv" -Destination "release/DS_AI_Quiz/data/"
          Write-Host "âœ… å¤åˆ¶: data/questions.csv"
        } else {
          Write-Host "âš ï¸  è­¦å‘Š: data/questions.csv ä¸å­˜åœ¨"
        }

        if (Test-Path "data/knowledge_graph.txt") {
          Copy-Item "data/knowledge_graph.txt" -Destination "release/DS_AI_Quiz/data/"
          Write-Host "âœ… å¤åˆ¶: data/knowledge_graph.txt"
        } else {
          Write-Host "âš ï¸  è­¦å‘Š: data/knowledge_graph.txt ä¸å­˜åœ¨"
        }

        # å¤åˆ¶ README å’Œ LICENSE
        if (Test-Path "README.md") {
          Copy-Item "README.md" -Destination "release/DS_AI_Quiz/"
          Write-Host "âœ… å¤åˆ¶: README.md"
        }

        if (Test-Path "LICENSE") {
          Copy-Item "LICENSE" -Destination "release/DS_AI_Quiz/"
          Write-Host "âœ… å¤åˆ¶: LICENSE"
        }

        Write-Host "`n=== å‘è¡Œç‰ˆç›®å½•ç»“æ„ ==="
        Get-ChildItem -Path "release/DS_AI_Quiz" -Recurse | Select-Object FullName

    - name: Create ZIP archive
      shell: pwsh
      run: |
        # è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
        $refName = "${{ github.ref_name }}"
        $version = $refName.TrimStart('v')
        $zipName = "DS_AI_Quiz-Windows-x64-v$version.zip"

        Write-Host "=== åˆ›å»º ZIP å‹ç¼©åŒ… ==="
        Write-Host "ç‰ˆæœ¬å·: $version"
        Write-Host "æ–‡ä»¶å: $zipName"

        # åˆ›å»º ZIP åŒ…ï¼ˆæ‰“åŒ…æ•´ä¸ª DS_AI_Quiz æ–‡ä»¶å¤¹ï¼‰
        Compress-Archive -Path "release/DS_AI_Quiz" -DestinationPath $zipName -Force

        # éªŒè¯ ZIP æ–‡ä»¶
        if (Test-Path $zipName) {
          $zipFile = Get-Item $zipName
          Write-Host "âœ… ZIP åˆ›å»ºæˆåŠŸ"
          Write-Host "   æ–‡ä»¶å¤§å°: $($zipFile.Length) å­—èŠ‚"
          Write-Host "   æ–‡ä»¶è·¯å¾„: $($zipFile.FullName)"
        } else {
          Write-Host "âŒ ZIP åˆ›å»ºå¤±è´¥"
          exit 1
        }

        # è¾“å‡ºæ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
        "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: DS_AI_Quiz-Windows-x64-v${{ env.VERSION }}
        path: ${{ env.ZIP_NAME }}
        if-no-files-found: error

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: ${{ env.ZIP_NAME }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## æ•°æ®ç»“æ„æ™ºèƒ½åˆ·é¢˜ç³»ç»Ÿ ${{ github.ref_name }}

          ### ğŸ“¦ Windows å‘è¡Œç‰ˆ

          ä¸‹è½½ `DS_AI_Quiz-Windows-x64-${{ github.ref_name }}.zip`ï¼Œè§£å‹åå³å¯ä½¿ç”¨ã€‚

          ### ğŸ“‹ ä½¿ç”¨è¯´æ˜

          1. è§£å‹ ZIP æ–‡ä»¶åˆ°ä»»æ„ç›®å½•
          2. ç¡®ä¿ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
             ```
             DS_AI_Quiz/
             â”œâ”€â”€ DS_AI_Quiz.exe
             â””â”€â”€ data/
                 â”œâ”€â”€ questions.csv
                 â””â”€â”€ knowledge_graph.txt
             ```
          3. åŒå‡» `DS_AI_Quiz.exe` è¿è¡Œï¼Œæˆ–åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ
          4. é¦–æ¬¡è¿è¡Œæ—¶è¾“å…¥å­¦å·/ç”¨æˆ·åå³å¯å¼€å§‹ä½¿ç”¨

          ### âœ¨ æ–°ç‰¹æ€§

          - âœ… æ™ºèƒ½è·¯å¾„å®šä½ï¼šä»ä»»æ„å·¥ä½œç›®å½•å¯åŠ¨éƒ½èƒ½æ­£å¸¸è¿è¡Œ
          - âœ… å¯åŠ¨è‡ªæ£€ï¼šè‡ªåŠ¨æ£€æŸ¥å¿…è¦æ–‡ä»¶å¹¶ç»™å‡ºå‹å¥½æç¤º
          - âœ… å¤šç”¨æˆ·æ”¯æŒï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„åšé¢˜è®°å½•
          - âœ… AI æ™ºèƒ½æ¨èï¼šåŸºäºå¤šç»´åº¦ç®—æ³•æ¨èç»ƒä¹ é¢˜ç›®
          - âœ… çŸ¥è¯†å›¾è°±ï¼šä¾èµ–å…³ç³»å¯è§†åŒ–ä¸å¤ä¹ è·¯å¾„è§„åˆ’
          - âœ… å­¦ä¹ æŠ¥å‘Šï¼šè‡ªåŠ¨ç”Ÿæˆ Markdown æ ¼å¼è¯¦ç»†æŠ¥å‘Š

          ### ğŸ“– å®Œæ•´æ–‡æ¡£

          è¯¦è§å‹ç¼©åŒ…å†…çš„ `README.md` æ–‡ä»¶ã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
